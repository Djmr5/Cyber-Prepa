{% extends 'layout/base.html' %}
{% load static %}

{% block title %}
Index
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'vendor/bootstrap-5.2.3-dist/css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'vendor/fontawesome-free-6.4.2-web/css/all.min.css' %}">
{% endblock %}

{% block content %}
<h1>Bienvenido a Ciber Tec</h1>
<div class="cyber__wrapper">

    <div class="cyber__cards">

        {% for game in games %}
        <div class="cyber__card [ is-collapsed ]">

            <div class="cyber__card__inner [ js-expander ]">
                <span>{{ game.displayName }}</span><br>
                <img class="cyber__image" src="{% static game.file_route %}" alt="Futbolito 1">
                <div class="remaining__time">
                    <p id="cyber__countdown__{{ forloop.counter }}"> No data</p>
                </div>
            </div>

            {% if user.is_authenticated %}
            <div class="cyber__card__expander">
            <link rel="stylesheet" href="{% static 'vendor/DataTables/datatables.min.css' %}">
                <i class="fa fa-close [ js-collapser ]"></i>
                <div class="collapsed__students">
                    <ul class="container-dropzone">
                        {% for player in game.plays_data %}
                        <div id="{{ player.student_id }}" class="student draggable" draggable="true">
                            <li>{{ player.student_id }}</li>
                            <form class="end-play-form" id="end-play-form-{{ player.student_id }}">
                                {% csrf_token %}
                                <input type="hidden" name="student_id" value="{{ player.student_id }}">
                                <button type="submit">End Play</button>
                                <button type="button" data-bs-toggle="modal" data-bs-target="#modalSanciones" data-bs-matricula="{{ player.student_id}}" >Sancionar</button>
                            </form>
                        </div>
                        {% endfor %}
                    </ul>
                    <form class="add-student-game" id="add-student-game-{{ game.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="game_id" value="{{ game.id }}">
                        <input type="text" name="student_id" placeholder="Student ID">
                        <button type="submit">Add Student</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}

    </div>

    <!-- modal: Change the user play -->
    <div id="confirmation_modal" class="change_play_modal">
        <div class="modal-content">
            <!-- <span class="close">&times;</span> -->
            <span>Estás seguro que quieres cambiar al usuario X del juego Y al juego Z</span>
            <div class="buttons-container">
                <button class="confirmation-button">Confirmar</button>
                <button class="reject-button">Cancelar</button>
            </div>
        </div>
    </div>

</div>
<div id="error-alert" class="alert alert-danger d-none" role="alert">
    <!-- Error messages will be inserted here -->
</div>

<!-- modal: add user to sanctions -->
<div class="modal fade" id="modalSanciones" tabindex="-1" aria-labelledby="modalSancionesLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalSancionesLabel">New message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="matriculaSancion" class="col-form-label">Matricula:</label>
            <input type="text" class="form-control" id="matriculaSancion">
          </div>
          <div class="mb-3">
            <label for="causaSancion" class="col-form-label">Causa:</label>
            <textarea class="form-control" id="causaSancion"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="sancionarBtn">Sancionar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<!-- Added Popper through CDN -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
    integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
    crossorigin="anonymous"></script>
<script src="{% static 'vendor/bootstrap-5.2.3-dist/js/bootstrap.min.js' %}"></script>
<script src="{% static 'js/cards.js' %}"></script>
{% if user.is_authenticated %}
<script src="{% static 'js/auth_cards.js' %}"></script>
<script src="{% static 'js/drag_drop.js' %}"></script>
{% endif %}

<!-- Script modal -->
<script type="text/javascript">

modalSanciones.addEventListener('show.bs.modal', function (event) {
    // Button that triggered the modal
    var button = event.relatedTarget
    var recipient = button.getAttribute('data-bs-matricula')
    // If necessary, you could initiate an AJAX request here
    // and then do the updating in a callback.
    // Update the modal's content.
    var modalTitle = modalSanciones.querySelector('.modal-title')
    var modalBodyInput = modalSanciones.querySelector('.modal-body input')

    modalTitle.textContent = 'Sancion'
    modalBodyInput.value = recipient
})
</script>

<!-- Script sancion -->
<script>
  document.getElementById("sancionarBtn").addEventListener("click", function() {
    var student_id = document.getElementById("matriculaSancion").value;
    var cause = document.getElementById("causaSancion").value;
      console.log(student_id)
      console.log(cause)

      var data = {
          student_id: student_id,
          cause: cause
      };

      fetch('api/add-student-to-sanctioned', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
      })
          .then(response => {
              if (response.ok) {
                  // La solicitud fue exitosa, puedes mostrar un mensaje de éxito o hacer otras acciones necesarias.
                  // document.getElementById("matriculaSancion").value = ''; // Limpia el campo de matrícula
                  // document.getElementById("causaSancion").value = ''; // Limpia el campo de causa
                  console.log("se hace")
              } else {
                  // La solicitud falló, puedes mostrar un mensaje de error o manejar el error de otra manera.
                  console.log("no se hace")
              }
          })
          .catch(error => {
              // Manejo de errores de red u otros errores inesperados.
              console.error('Error:', error);
          });
  });
</script>
{% endblock %}
